<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>1時間ループ再生</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "ヒラギノ角ゴ ProN", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    .player { margin-top: 16px; }
    .controls { margin-top: 12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .time { font-weight: 600; }
    .notice { margin-top:10px; color: #666; font-size:0.9rem; }
  </style>
</head>
<body>
  <h1>ファイルを選択して1時間ループ再生</h1>

  <p>ローカルの音声または動画ファイルを選択してください。選択時に再生が始まり、合計で1時間経過するまでファイルをループ再生します。</p>

  <input id="fileInput" type="file" accept="audio/*,video/*" />
  <div class="player" id="playerContainer"></div>

  <div class="controls">
    <button id="startBtn" disabled>開始</button>
    <button id="stopBtn" disabled>停止</button>
    <div class="time">残り時間: <span id="remaining">--:--:--</span></div>
  </div>

  <div class="notice">
    ※ ファイルの選択はユーザー操作となるため、ブラウザが自動再生ブロックを回避できます。ファイル長が1時間より長い場合は途中で停止します。  
  </div>

<script>
(function(){
  const fileInput = document.getElementById('fileInput');
  const playerContainer = document.getElementById('playerContainer');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const remainingEl = document.getElementById('remaining');

  let media = null;               // HTMLMediaElement (audio/video)
  let objectUrl = null;
  const TOTAL_MS = 3600 * 1000;   // 1時間 = 3600秒
  let startTime = null;           // Date.now() when started
  let running = false;
  let rafId = null;

  function formatTime(ms) {
    if (ms < 0) ms = 0;
    const s = Math.floor(ms / 1000);
    const hh = String(Math.floor(s / 3600)).padStart(2, '0');
    const mm = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
    const ss = String(s % 60).padStart(2, '0');
    return `${hh}:${mm}:${ss}`;
  }

  function updateRemaining() {
    if (!running || startTime === null) return;
    const elapsed = Date.now() - startTime;
    const remaining = TOTAL_MS - elapsed;
    remainingEl.textContent = formatTime(remaining);
    if (remaining <= 0) {
      // 終了
      stopPlayback();
      return;
    }
    rafId = requestAnimationFrame(updateRemaining);
  }

  function beginPlayback() {
    if (!media) return;
    // if media already playing, do nothing except set running
    startTime = startTime ?? Date.now(); // if already started, keep original startTime
    running = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    media.play().catch((e) => {
      // ブラウザが再生をブロックする可能性
      console.warn('Play failed:', e);
    });
    if (!rafId) updateRemaining();
  }

  function stopPlayback() {
    running = false;
    if (media) {
      try { media.pause(); } catch(e){}
    }
    startBtn.disabled = false;
    stopBtn.disabled = true;
    startTime = null;
    remainingEl.textContent = formatTime(0);
    if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
  }

  function cleanupMedia() {
    if (media) {
      media.removeEventListener('ended', onEnded);
      try { media.pause(); } catch(e){}
      playerContainer.innerHTML = '';
      media = null;
    }
    if (objectUrl) {
      URL.revokeObjectURL(objectUrl);
      objectUrl = null;
    }
    stopPlayback();
  }

  function onEnded() {
    // 再生が終わった → まだ1時間経っていなければ先頭に戻して再生
    if (!running || startTime === null) return;
    const elapsed = Date.now() - startTime;
    if (elapsed < TOTAL_MS) {
      try {
        media.currentTime = 0;
        media.play().catch((e)=>{console.warn('loop play failed', e);});
      } catch(e) {
        // 一部形式や環境で currentTime 書き換えが禁止される可能性
        console.warn('reloop error', e);
      }
    } else {
      stopPlayback();
    }
  }

  fileInput.addEventListener('change', (ev) => {
    cleanupMedia();
    const f = ev.target.files && ev.target.files[0];
    if (!f) return;
    objectUrl = URL.createObjectURL(f);

    // audio か video を判定。タイプが空なら拡張子から推測。
    const t = f.type || '';
    const isVideo = t.startsWith('video') || /\.(mp4|webm|ogg|mov|mkv)$/i.test(f.name);
    if (isVideo) {
      media = document.createElement('video');
      media.width = 640;
      media.height = 360;
      media.controls = true;
      media.playsInline = true;
    } else {
      media = document.createElement('audio');
      media.controls = true;
    }
    media.src = objectUrl;
    media.preload = 'auto';
    media.style.maxWidth = '100%';
    media.addEventListener('ended', onEnded);
    playerContainer.appendChild(media);

    // 初期状態: 開始ボタンを有効にしておく（ファイル選択はユーザー操作なので再生可能なことが多い）
    startBtn.disabled = false;
    stopBtn.disabled = true;
    remainingEl.textContent = formatTime(TOTAL_MS);
    // 自動で開始したければ以下を有効に（ただしブラウザ自動再生制限に注意）
    // startPlayback();
  });

  startBtn.addEventListener('click', () => {
    if (!media) return;
    // 新しく開始する場合は startTime を現在にリセット
    startTime = Date.now();
    running = true;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    // すでにファイルが最後まである場合や長い場合も、1時間ループのために ended イベントで判断する
    media.currentTime = 0;
    media.play().catch((e) => console.warn('play error', e));
    if (!rafId) updateRemaining();
  });

  stopBtn.addEventListener('click', () => {
    stopPlayback();
  });

  // ウィンドウを閉じる／リロード時にオブジェクトURL解放
  window.addEventListener('beforeunload', cleanupMedia);

})();
</script>
</body>
</html>