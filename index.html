<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ã‚¿ãƒ¼ï¼ˆéŸ³å£°ãƒ»å‹•ç”»ï¼‹ã‚µãƒ ãƒã‚¤ãƒ«ï¼‹EQ/ãƒ”ãƒƒãƒï¼‰</title>
    <style>
        #mediaPlayer {
            width: 100%;
            max-width: 640px;
            display: block;
            margin-bottom: 1em;
        }
        .thumb {
            width: 80px;
            height: 45px;
            object-fit: cover;
        }
        .current {
            background-color: #f0f0f0;
        }
        /* ã‚¤ã‚³ãƒ©ã‚¤ã‚¶ãƒ¼ã¨ãƒ”ãƒƒãƒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #audioControls {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .eq-band, #pitchControl {
            margin-bottom: 10px;
        }
        .eq-band label, #pitchControl label {
            display: inline-block;
            width: 50px;
            text-align: right;
            margin-right: 10px;
            font-size: small;
        }
    </style>
</head>
<body>
    <input type="file" multiple id="fileInput" accept=".mp3,.wav,.ogg,.m4a,.aac,.flac,.wma,.aiff,.mp4,.m4v,.mov,.webm,.avi,.wmv,.mkv,.flv,.3gp"><br>
    
    <div id="playerContainer"></div>
    <p id="songInfo"></p>
    
    <div id="audioControls">
        <h3>ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¨­å®š</h3>
        <div id="equalizer">
            <h4>ã‚¤ã‚³ãƒ©ã‚¤ã‚¶ãƒ¼ (dB)</h4>
            <div class="eq-band"><label for="eq60">60Hz:</label><input type="range" id="eq60" min="-12" max="12" value="0" step="0.1"><span class="gain-value">0.0</span></div>
            <div class="eq-band"><label for="eq250">250Hz:</label><input type="range" id="eq250" min="-12" max="12" value="0" step="0.1"><span class="gain-value">0.0</span></div>
            <div class="eq-band"><label for="eq1k">1kHz:</label><input type="range" id="eq1k" min="-12" max="12" value="0" step="0.1"><span class="gain-value">0.0</span></div>
            <div class="eq-band"><label for="eq4k">4kHz:</label><input type="range" id="eq4k" min="-12" max="12" value="0" step="0.1"><span class="gain-value">0.0</span></div>
            <div class="eq-band"><label for="eq16k">16kHz:</label><input type="range" id="eq16k" min="-12" max="12" value="0" step="0.1"><span class="gain-value">0.0</span></div>
        </div>
        
        <div id="pitchControl">
            <h4>ãƒ”ãƒƒãƒ/å†ç”Ÿé€Ÿåº¦</h4>
            <label for="pitch">é€Ÿåº¦:</label>
            <input type="range" id="pitch" min="0.5" max="2.0" value="1.0" step="0.01">
            <span id="pitchValue">1.00</span> (xå€é€Ÿ)
        </div>
    </div>
    
    <br>
    
    <table>
        <thead>
            <tr>
                <th>ã‚µãƒ ãƒã‚¤ãƒ«</th>
                <th>ãƒ¡ãƒ‡ã‚£ã‚¢å</th>
                <th>é•·ã•</th>
            </tr>
        </thead>
        <tbody id="playHistoryTable"></tbody>
    </table>
    
    <button id="prevButton">å‰ã®ãƒ¡ãƒ‡ã‚£ã‚¢</button>
    <button id="nextButton">æ¬¡ã®ãƒ¡ãƒ‡ã‚£ã‚¢</button>
    <button id="sleepTimerButton">ã‚¿ã‚¤ãƒãƒ¼: ã‚ªãƒ•</button>

<script>
const fileInput = document.getElementById("fileInput");
const playerContainer = document.getElementById("playerContainer");
const songInfo = document.getElementById("songInfo");
const playHistoryTable = document.getElementById("playHistoryTable");
const prevButton = document.getElementById("prevButton");
const nextButton = document.getElementById("nextButton");

// ã‚¤ã‚³ãƒ©ã‚¤ã‚¶ãƒ¼ã¨ãƒ”ãƒƒãƒé–¢é€£ã®è¦ç´ 
const eqBands = [
    { freq: 60, input: document.getElementById('eq60') },
    { freq: 250, input: document.getElementById('eq250') },
    { freq: 1000, input: document.getElementById('eq1k') },
    { freq: 4000, input: document.getElementById('eq4k') },
    { freq: 16000, input: document.getElementById('eq16k') }
];
const pitchInput = document.getElementById('pitch');
const pitchValueSpan = document.getElementById('pitchValue');

let playlist = []; // {file, url, duration, isVideo, thumbnail}
let currentTrackIndex = 0;
let currentPlayer = null;

// Web Audio APIã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
let audioContext = null;
let sourceNode = null;
let eqNodes = [];

// --- ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã¨ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ ---

fileInput.addEventListener("change", () => {
    const files = [...fileInput.files];
    files.forEach(file => addToPlaylist(file));
    fileInput.value = "";
});

function addToPlaylist(file) {
    const url = URL.createObjectURL(file);
    const isVideo = file.type.startsWith("video/");
    const tempEl = document.createElement(isVideo ? "video" : "audio");
    tempEl.preload = "metadata";
    tempEl.src = url;

    tempEl.addEventListener("loadedmetadata", async () => {
        const duration = tempEl.duration;
        let thumbnail = null;

        if (isVideo) {
            thumbnail = await generateThumbnail(url);
        }

        playlist.push({ file, url, duration, isVideo, thumbnail });

        if (playlist.length === 1 && !currentPlayer) {
            // åˆå›å†ç”Ÿæ™‚ã«ã€å†ç”Ÿã‚’é–‹å§‹ã™ã‚‹
            playTrack(0);
        } else {
            updatePlayHistory();
        }

        tempEl.remove();
    });
}

function generateThumbnail(videoUrl) {
    return new Promise((resolve) => {
        const video = document.createElement("video");
        video.src = videoUrl;
        video.crossOrigin = "anonymous";
        video.muted = true;
        video.currentTime = 0.1;

        video.addEventListener("loadeddata", () => {
            const canvas = document.createElement("canvas");
            canvas.width = 160;
            canvas.height = 90;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL("image/png"));
        });

        video.addEventListener("error", () => {
            resolve(null); // fallback
        });
    });
}

// --- ãƒ¡ãƒ‡ã‚£ã‚¢å†ç”Ÿã¨Web Audio APIæ¥ç¶š ---

function playTrack(index) {
    if (!playlist[index]) return;
    const { file, url, duration, isVideo } = playlist[index];
    currentTrackIndex = index;

    if (currentPlayer) {
        currentPlayer.pause();
        currentPlayer.remove();
        // å¤ã„ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªæ¥ç¶šã‚’è§£é™¤
        if (sourceNode) sourceNode.disconnect();
    }

    currentPlayer = document.createElement(isVideo ? "video" : "audio");
    currentPlayer.id = "mediaPlayer";
    currentPlayer.controls = true;
    currentPlayer.autoplay = true;
    currentPlayer.src = url;
    if (isVideo) currentPlayer.width = 640;
    currentPlayer.addEventListener("ended", playNextTrack);
    
    // ãƒ”ãƒƒãƒå¤‰æ›´ã¯HTMLMediaElementã®playbackRateã§ç›´æ¥åˆ¶å¾¡ã™ã‚‹ãŸã‚ã€åˆæœŸå€¤ã‚’è¨­å®š
    currentPlayer.playbackRate = parseFloat(pitchInput.value);

    playerContainer.innerHTML = "";
    playerContainer.appendChild(currentPlayer);

    songInfo.textContent = `å†ç”Ÿä¸­: ${file.name} (${getFormattedDuration(duration)})`;
    updatePlayHistory();
    
    // Web Audio APIã®è¨­å®š
    setupAudioContext();
}

function setupAudioContext() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    
    // æ—¢å­˜ã®æ¥ç¶šã‚’è§£é™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆ
    if (sourceNode) sourceNode.disconnect();
    eqNodes = [];
    
    // MediaElementSourceNodeã‚’ä½œæˆ
    sourceNode = audioContext.createMediaElementSource(currentPlayer);
    
    let previousNode = sourceNode;
    
    // ã‚¤ã‚³ãƒ©ã‚¤ã‚¶ãƒ¼(BiquadFilterNode)ã®ä½œæˆã¨æ¥ç¶š
    eqBands.forEach(band => {
        const filter = audioContext.createBiquadFilter();
        filter.type = 'peaking'; // ãƒ”ãƒ¼ã‚¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        filter.frequency.setValueAtTime(band.freq, audioContext.currentTime);
        filter.Q.setValueAtTime(1.0, audioContext.currentTime); // Qå€¤ (å¸¯åŸŸå¹…)
        filter.gain.setValueAtTime(parseFloat(band.input.value), audioContext.currentTime); // ã‚²ã‚¤ãƒ³
        
        eqNodes.push(filter);
        
        // ãƒãƒ¼ãƒ‰ã‚’æ¥ç¶š
        previousNode.connect(filter);
        previousNode = filter;
    });
    
    // æœ€å¾Œã®ãƒãƒ¼ãƒ‰ã‚’AudioContextã®å‡ºåŠ›ï¼ˆã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ï¼‰ã«æ¥ç¶š
    previousNode.connect(audioContext.destination);
    
    // Web Audio APIã®æ¥ç¶šãŒå®Œäº†ã—ãŸã‚‰ã€å†ç”Ÿã‚’å†é–‹ï¼ˆã‚‚ã—ä¸€æ™‚åœæ­¢ã—ã¦ã„ãŸã‚‰ï¼‰
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }
    
    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã§åˆæœŸè¨­å®šã¨ãƒªã‚¹ãƒŠãƒ¼ã®å†è¨­å®š
    eqBands.forEach(({ freq, input }) => {
        // ã‚¹ãƒ‘ãƒ³ã«åˆæœŸå€¤ã‚’è¡¨ç¤º
        input.nextElementSibling.textContent = parseFloat(input.value).toFixed(1);
    });
}

// --- ã‚¤ã‚³ãƒ©ã‚¤ã‚¶ãƒ¼ã¨ãƒ”ãƒƒãƒã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ---

eqBands.forEach(({ freq, input }, index) => {
    input.addEventListener('input', () => {
        const gainValue = parseFloat(input.value);
        input.nextElementSibling.textContent = gainValue.toFixed(1);
        
        if (eqNodes[index]) {
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚²ã‚¤ãƒ³ã‚’å¤‰æ›´
            eqNodes[index].gain.setValueAtTime(gainValue, audioContext.currentTime);
        }
    });
});

pitchInput.addEventListener('input', () => {
    const rate = parseFloat(pitchInput.value);
    pitchValueSpan.textContent = rate.toFixed(2);
    
    if (currentPlayer) {
        // HTMLMediaElementã®playbackRateã§ãƒ”ãƒƒãƒ/å†ç”Ÿé€Ÿåº¦ã‚’å¤‰æ›´
        currentPlayer.playbackRate = rate;
    }
});

// --- å†ç”ŸãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ---

function playNextTrack() {
    if (!playlist.length) return;
    const nextIndex = (currentTrackIndex + 1) % playlist.length;
    playTrack(nextIndex);
}

function playPrevTrack() {
    if (!playlist.length) return;
    const prevIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
    playTrack(prevIndex);
}

prevButton.addEventListener("click", playPrevTrack);
nextButton.addEventListener("click", playNextTrack);

// --- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆè¡¨ç¤º ---

function updatePlayHistory() {
    playHistoryTable.innerHTML = "";
    playlist.forEach((track, i) => {
        const row = playHistoryTable.insertRow();
        if (i === currentTrackIndex) row.classList.add("current");

        const thumbCell = row.insertCell();
        const nameCell = row.insertCell();
        const durCell = row.insertCell();

        if (track.thumbnail) {
            const img = document.createElement("img");
            img.src = track.thumbnail;
            img.className = "thumb";
            thumbCell.appendChild(img);
        } else {
            thumbCell.textContent = track.isVideo ? "ğŸ¬" : "ğŸµ";
        }

        nameCell.textContent = track.file.name;
        durCell.textContent = getFormattedDuration(track.duration);

        row.addEventListener("click", () => playTrack(i));
    });
}

function getFormattedDuration(seconds) {
    if (!isFinite(seconds)) return "--:--";
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${m}:${s < 10 ? "0" : ""}${s}`;
}
    
// --- ã‚¹ãƒªãƒ¼ãƒ—ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ ---

const sleepTimerButton = document.getElementById("sleepTimerButton");
const timerOptions = [5, 10, 15, 30, 60, 120, 0]; // åˆ†
let timerIndex = 0;
let sleepTimeout = null;
let fadeOutInterval = null;

sleepTimerButton.addEventListener("click", () => {
    timerIndex = (timerIndex + 1) % timerOptions.length;
    const minutes = timerOptions[timerIndex];
    setSleepTimer(minutes);
});

function setSleepTimer(minutes) {
    if (sleepTimeout) {
        clearTimeout(sleepTimeout);
        sleepTimeout = null;
    }
    if (fadeOutInterval) {
        clearInterval(fadeOutInterval);
        fadeOutInterval = null;
    }

    if (minutes === 0) {
        sleepTimerButton.textContent = "ã‚¿ã‚¤ãƒãƒ¼: ã‚ªãƒ•";
        return;
    }

    sleepTimerButton.textContent = `ã‚¿ã‚¤ãƒãƒ¼: ${minutes}åˆ†`;

    sleepTimeout = setTimeout(() => {
        startFadeOutAndStop();
    }, minutes * 60 * 1000);
}

function startFadeOutAndStop() {
    if (!currentPlayer) return;

    let duration = 30; // 30ç§’
    let steps = 30; // 1ç§’ã”ã¨ã«
    let stepCount = 0;
    let initialVolume = currentPlayer.volume;
    if (initialVolume === 0) initialVolume = 1; // 0ã®å ´åˆã¯1ã¨ã—ã¦æ‰±ã†

    fadeOutInterval = setInterval(() => {
        stepCount++;
        // Web Audio APIã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€éŸ³é‡åˆ¶å¾¡ã¯AudioContextã®ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã®ãŒç†æƒ³çš„ã ãŒã€
        // ç°¡ç•¥åŒ–ã®ãŸã‚HTMLMediaElementã®volumeã‚’ä½¿ç”¨ã€‚ã‚¤ã‚³ãƒ©ã‚¤ã‚¶ãƒ¼ãŒæœ‰åŠ¹ã§ã‚‚æ©Ÿèƒ½ã™ã‚‹ã€‚
        currentPlayer.volume = Math.max(0, initialVolume * (1 - stepCount / steps));
        
        if (stepCount >= steps) {
            clearInterval(fadeOutInterval);
            currentPlayer.pause();
            currentPlayer.currentTime = 0;
            currentPlayer.volume = initialVolume; // æ¬¡å›ã®ãŸã‚ã«éŸ³é‡ã‚’æˆ»ã™
            sleepTimerButton.textContent = "ã‚¿ã‚¤ãƒãƒ¼: ã‚ªãƒ•";
        }
    }, duration * 1000 / steps);
}
</script>

</body>
</html>